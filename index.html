<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElXora</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"/>
</head>
<body>

  <!-- Redirect if not logged in -->
  <script>
    if (!localStorage.getItem('elxora_current_user')) {
      window.location.replace('login.html');
    }
  </script>

  <div id="app-container" class="app-container">
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <button id="sidebar-close-btn" class="close-sidebar">Ã—</button>
      </div>
      <button id="new-chat-btn">+ New Chat</button>
      <div id="chat-list" class="chat-list"></div>
      <div id="user-info" class="user-info clickable">
        <div class="avatar" id="avatar"></div>
        <div class="user-details">
          <strong id="username-display"></strong>
          <small id="email-display"></small>
        </div>
      </div>
    </aside>

    <main id="main-chat" class="main-chat">
      <header>
        <button id="mobile-sidebar-toggle" class="mobile-sidebar-toggle">â˜°</button>
        <div class="chat-header-title">
          <h2 id="chat-title">New Chat</h2>
          <small class="subtitle">Powered by Gemini â€¢ ElXora</small>
        </div>
      </header>

      <div id="chat-messages" class="chat-messages"></div>

      <div id="typing-indicator" class="typing-indicator hidden">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <button id="attach-btn" class="attach-btn" title="Attach file">ðŸ“Ž</button>
          <textarea id="message-input" rows="1" placeholder="Message ElXora..." aria-label="Type your message"></textarea>
          <button id="send-btn" class="send-btn" title="Send" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>
        <input type="file" id="file-input" hidden/>
      </div>
    </main>
  </div>

  <!-- Logout Modal -->
  <div id="logout-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Log Out?</h2>
      <p>Are you sure you want to log out?</p>
      <div class="modal-buttons">
        <button id="confirm-logout">Yes</button>
        <button id="cancel-logout">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // CONFIG
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const GEMINI_API_BASE = "https://generativelanguage.googleapis.com/v1beta";
    const GEMINI_MODEL    = "gemini-2.0-flash";  // Gemini 2.0 Flash

    // â”€â”€â”€ Load API key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const API_KEY = process.env.GEMINI_API_KEY || "AIzaSyBDnsH0DDfrulYKruh1YOkY1cy-Liogt6o";  // Use env var (GitHub secret) if available, fallback to hardcoded for local

    const SYSTEM_PROMPT = `You are a highly skilled, friendly senior developer who masters Luau (Roblox), Python, JavaScript/TypeScript, HTML, CSS.
You love using emojis ðŸ˜„ðŸš€ to make answers more engaging and fun when it feels natural.
Always write clean, modern, well-commented code.
When showing code:
- Wrap in triple backticks with correct language tag (```python, ```luau, ```js, ```html, ```css, ```ts etc.)
- Never send broken or incomplete code unless debugging
- After longer code (>10 lines) add a short explanation
- Use best practices, modern syntax, avoid deprecated features
Feel free to use emojis in your normal text responses to make them more lively and human ðŸ˜ŠðŸ‘`;

    const WELCOME_MESSAGE = `Hey There ðŸ‘‹  
What can I help you with today? ðŸš€`;

    // â”€â”€â”€ DOM Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const 
      authContainer      = document.getElementById('auth-container'),
      appContainer       = document.getElementById('app-container'),
      loginForm          = document.getElementById('login-form'),
      signupForm         = document.getElementById('signup-form'),
      verifyForm         = document.getElementById('verification-form'),
      chatMessages       = document.getElementById('chat-messages'),
      messageInput       = document.getElementById('message-input'),
      sendBtn            = document.getElementById('send-btn'),
      attachBtn          = document.getElementById('attach-btn'),
      fileInput          = document.getElementById('file-input'),
      typingIndicator    = document.getElementById('typing-indicator'),
      chatTitle          = document.getElementById('chat-title'),
      toastEl            = document.getElementById('toast');

    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentUser = null;

    // â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type = 'info') {
      toastEl.textContent = msg;
      toastEl.className = `toast ${type}`;
      toastEl.classList.remove('hidden');
      setTimeout(() => toastEl.classList.add('hidden'), 3800);
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function autoGrow(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + "px";
    }

    function renderMessage(sender, content) {
      const div = document.createElement('div');
      div.className = `message ${sender}-message`;
      div.innerHTML = `<div class="message-content">${marked.parse(content)}</div>`;
      chatMessages.appendChild(div);
      scrollToBottom();

      // Code highlighting + copy button
      if (sender === 'ai') {
        setTimeout(() => {
          document.querySelectorAll('pre code').forEach((block) => {
            if (!block.dataset.processed) {
              Prism.highlightElement(block);
              const pre = block.parentElement;
              const copyBtn = document.createElement('button');
              copyBtn.className = 'copy-btn';
              copyBtn.textContent = 'Copy';
              copyBtn.onclick = () => {
                navigator.clipboard.writeText(block.textContent);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
              };
              pre.appendChild(copyBtn);
              block.dataset.processed = 'true';
            }
          });
        }, 100);
      }
    }

    // â”€â”€â”€ Auth Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getUser() {
      return JSON.parse(localStorage.getItem('elxora_user'));
    }

    function setUser(user) {
      localStorage.setItem('elxora_user', JSON.stringify(user));
      currentUser = user;
    }

    function showLogin()  { loginForm.classList.remove('hidden');  signupForm.classList.add('hidden'); verifyForm.classList.add('hidden'); }
    function showSignup() { signupForm.classList.remove('hidden'); loginForm.classList.add('hidden');  verifyForm.classList.add('hidden'); }
    function showVerify() { verifyForm.classList.remove('hidden'); loginForm.classList.add('hidden');  signupForm.classList.add('hidden'); }

    document.getElementById('signup-btn').addEventListener('click', () => {
      const email    = document.getElementById('signup-email').value.trim();
      const username = document.getElementById('signup-username').value.trim();
      const pass     = document.getElementById('signup-password').value;
      const confirm  = document.getElementById('signup-confirm-password').value;

      let error = false;
      document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
      document.querySelectorAll('input').forEach(inp => inp.classList.remove('error'));

      if (!email.includes('@'))               { document.getElementById('signup-email-error').textContent = 'Invalid email'; error = true; }
      if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) { document.getElementById('signup-username-error').textContent = '3-20 chars: a-z0-9_'; error = true; }
      if (pass.length < 6)                    { document.getElementById('signup-password-error').textContent = 'â‰¥ 6 characters'; error = true; }
      if (pass !== confirm)                   { document.getElementById('signup-confirm-error').textContent = 'Passwords do not match'; error = true; }

      const existing = getUser();
      if (existing && existing.email === email) {
        document.getElementById('signup-general-error').textContent = 'Email already registered';
        error = true;
      }

      if (error) return;

      localStorage.setItem('temp_signup', JSON.stringify({email, username, pass}));
      showVerify();
      showToast('Use verification code: 123456', 'info');
    });

    document.getElementById('verify-btn').addEventListener('click', () => {
      const code = [...verifyForm.querySelectorAll('input')].map(i => i.value.trim()).join('');
      if (code !== '123456') {
        document.getElementById('verify-error').textContent = 'Incorrect code';
        return;
      }

      const temp = JSON.parse(localStorage.getItem('temp_signup') || '{}');
      if (!temp.email) {
        showToast('Session expired â€” please sign up again', 'error');
        showSignup();
        return;
      }

      setUser({ email: temp.email, username: temp.username, pass: temp.pass });
      localStorage.removeItem('temp_signup');
      showToast('Account created successfully! ðŸŽ‰', 'success');
      enterApp();
    });

    document.getElementById('login-btn').addEventListener('click', () => {
      const email = document.getElementById('login-email').value.trim();
      const pass  = document.getElementById('login-password').value;
      const user  = getUser();

      document.querySelectorAll('.error-text').forEach(el => el.textContent = '');

      if (!user) {
        document.getElementById('login-general-error').textContent = 'No account found â€” please sign up first';
        return;
      }
      if (user.email !== email) {
        document.getElementById('login-email-error').textContent = 'Account not found';
        return;
      }
      if (user.pass !== pass) {
        document.getElementById('login-password-error').textContent = 'Invalid password';
        return;
      }

      showToast(`Welcome back, ${user.username}! ðŸš€`, 'success');
      enterApp();
    });

    document.getElementById('signup-link').addEventListener('click', e => { e.preventDefault(); showSignup(); });
    document.getElementById('login-link').addEventListener('click', e => { e.preventDefault(); showLogin(); });

    // â”€â”€â”€ Gemini API Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function callGemini(userMessage) {
      try {
        const response = await fetch(
          `${GEMINI_API_BASE}/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ role: 'user', parts: [{ text: userMessage }] }],
              systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
              generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
            })
          }
        );

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'No response received';
      } catch (err) {
        console.error(err);
        showToast('Gemini API error: ' + err.message, 'error');
        return null;
      }
    }

    // â”€â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      renderMessage('user', text);
      messageInput.value = '';
      autoGrow(messageInput);
      sendBtn.disabled = true;
      typingIndicator.classList.remove('hidden');
      scrollToBottom();

      const reply = await callGemini(text);

      typingIndicator.classList.add('hidden');
      if (reply) {
        renderMessage('ai', reply);
      } else {
        renderMessage('ai', "Sorry, something went wrong with the AI response ðŸ˜•");
      }
    }

    messageInput.addEventListener('input', () => {
      autoGrow(messageInput);
      sendBtn.disabled = !messageInput.value.trim();
    });

    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('load', () => {
      currentUser = getCurrentUser();
      if (currentUser) {
        enterApp();
      } else {
        showLogin();
      }

      // Verification code auto-focus next field
      const verifyInputs = document.querySelectorAll('.verification-inputs input');
      verifyInputs.forEach((input, index) => {
        input.addEventListener('input', () => {
          if (input.value.length === 1 && index < 5) {
            verifyInputs[index + 1].focus();
          }
        });
      });
    });
  </script>
</body>
</html>
