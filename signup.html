<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElXora - Sign Up</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

  <div class="auth-container">
    <div id="signup-form" class="auth-form">
      <h1>ElXora</h1>
      <h2>Create Account</h2>
      <div class="input-group">
        <input type="email" id="signup-email" placeholder="Email" required/>
        <div id="signup-email-error" class="error-text"></div>
      </div>
      <div class="input-group">
        <input type="text" id="signup-username" placeholder="Username (3-20 chars)" required/>
        <div id="signup-username-error" class="error-text"></div>
      </div>
      <div class="input-group">
        <input type="password" id="signup-password" placeholder="Password" required/>
        <div id="signup-password-error" class="error-text"></div>
      </div>
      <div class="input-group">
        <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required/>
        <div id="signup-confirm-error" class="error-text"></div>
      </div>
      <button id="signup-btn">Sign Up</button>
      <div id="signup-general-error" class="error-text center"></div>
      <p>Already have an account? <a href="login.html">Log in</a></p>
    </div>

    <!-- Verification form -->
    <div id="verification-form" class="auth-form hidden">
      <h1>ElXora</h1>
      <h2>Verify Email</h2>
      <p>Enter the 6-digit code sent to your email</p>
      <div class="verification-inputs">
        <input type="text" maxlength="1" pattern="\d" required autofocus/>
        <input type="text" maxlength="1" pattern="\d" required/>
        <input type="text" maxlength="1" pattern="\d" required/>
        <input type="text" maxlength="1" pattern="\d" required/>
        <input type="text" maxlength="1" pattern="\d" required/>
        <input type="text" maxlength="1" pattern="\d" required/>
      </div>
      <button id="verify-btn">Verify</button>
      <div id="verify-error" class="error-text center"></div>
      <p><a href="#" id="back-to-signup">Back to sign up</a></p>
    </div>
  </div>

  <script>
    const USERS_KEY = 'elxora_users';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKdjN5rmMG_Diaw-AbLeG1G5Jn38BFc4o5y95MHNDGaJnAroY9PrHFMCjw2VaJ5bkp/exec';

    function getUsers() {
      return JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
    }

    function saveUsers(users) {
      localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }

    // Show/hide forms
    function showSignup() {
      document.getElementById('signup-form').classList.remove('hidden');
      document.getElementById('verification-form').classList.add('hidden');
    }

    function showVerify() {
      document.getElementById('signup-form').classList.add('hidden');
      document.getElementById('verification-form').classList.remove('hidden');
      document.querySelector('.verification-inputs input').focus();
    }

    // Auto-focus next input
    const verifyInputs = document.querySelectorAll('.verification-inputs input');
    verifyInputs.forEach((input, index) => {
      input.addEventListener('input', () => {
        if (input.value.length === 1 && index < 5) {
          verifyInputs[index + 1].focus();
        }
      });
    });

    // SIGN UP button â€“ generate OTP and send real email
    document.getElementById('signup-btn').addEventListener('click', async () => {
      const email    = document.getElementById('signup-email').value.trim();
      const username = document.getElementById('signup-username').value.trim();
      const pass     = document.getElementById('signup-password').value;
      const confirm  = document.getElementById('signup-confirm-password').value;

      let hasError = false;
      document.querySelectorAll('.error-text').forEach(el => el.textContent = '');

      if (!email.includes('@') || !email.includes('.')) {
        document.getElementById('signup-email-error').textContent = 'Valid email required';
        hasError = true;
      }
      if (username.length < 3 || username.length > 20 || !/^[a-zA-Z0-9_]+$/.test(username)) {
        document.getElementById('signup-username-error').textContent = '3-20 chars: letters, numbers, _';
        hasError = true;
      }
      if (pass.length < 6) {
        document.getElementById('signup-password-error').textContent = 'â‰¥ 6 characters';
        hasError = true;
      }
      if (pass !== confirm) {
        document.getElementById('signup-confirm-error').textContent = 'Passwords do not match';
        hasError = true;
      }

      const users = getUsers();
      if (users.some(u => u.email === email)) {
        document.getElementById('signup-general-error').textContent = 'Email already registered';
        hasError = true;
      }
      if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
        document.getElementById('signup-general-error').textContent = 'Username taken';
        hasError = true;
      }

      if (hasError) return;

      // Generate real 6-digit code
      const generatedCode = Math.floor(100000 + Math.random() * 900000).toString();

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',  // Important for Google Apps Script
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            username: username,
            code: generatedCode
          })
        });

        // Store temp data for verification
        localStorage.setItem('temp_signup', JSON.stringify({
          email,
          username,
          pass,
          code: generatedCode,
          timestamp: Date.now()
        }));

        showVerify();
        alert(`A 6-digit code has been sent to ${email}\nCheck your inbox/spam folder (may take up to 60 seconds)`);

      } catch (err) {
        console.error('Failed to send OTP:', err);
        alert('Error sending code. Check console (F12) and try again.');
      }
    });

    // VERIFY button
    document.getElementById('verify-btn').addEventListener('click', () => {
      const enteredCode = Array.from(verifyInputs).map(i => i.value.trim()).join('');
      const temp = JSON.parse(localStorage.getItem('temp_signup') || '{}');

      if (!temp.email || !temp.code) {
        alert('Session expired â€” please sign up again');
        showSignup();
        return;
      }

      // Check expiry (10 minutes)
      if (Date.now() - temp.timestamp > 10 * 60 * 1000) {
        alert('Code expired. Please sign up again.');
        localStorage.removeItem('temp_signup');
        showSignup();
        return;
      }

      if (enteredCode !== temp.code) {
        document.getElementById('verify-error').textContent = 'Incorrect code';
        return;
      }

      // Success â€“ create account
      const users = getUsers();
      users.push({
        email: temp.email,
        username: temp.username,
        pass: temp.pass  // plaintext for now â€“ only prototype!
      });
      saveUsers(users);

      localStorage.setItem('elxora_current_user', JSON.stringify({
        email: temp.email,
        username: temp.username
      }));

      localStorage.removeItem('temp_signup');

      alert('Email verified! Welcome to ElXora ðŸŽ‰');
      window.location.href = 'index.html';
    });

    // Back link
    document.getElementById('back-to-signup')?.addEventListener('click', (e) => {
      e.preventDefault();
      showSignup();
    });

    // Start on signup form
    showSignup();
  </script>
</body>
  </html>
