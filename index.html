<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElXora</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"/>
</head>
<body>

  <!-- Protection: redirect to login if not logged in -->
  <script>
    (function() {
      const currentUser = localStorage.getItem('elxora_current_user');
      if (!currentUser) {
        window.location.replace('login.html');
      }
    })();
  </script>

  <div id="app-container" class="app-container">
    <aside id="sidebar" class="sidebar">
      <button id="new-chat-btn">+ New Chat</button>
      <div id="chat-list" class="chat-list"></div>
      <div id="user-info" class="user-info">
        <div class="avatar" id="avatar"></div>
        <div class="user-details">
          <strong id="username-display"></strong>
          <small id="email-display"></small>
        </div>
      </div>
      <button id="logout-btn" style="margin:16px; padding:12px; background:#e11d48; color:white; border:none; border-radius:8px; cursor:pointer;">
        Log Out
      </button>
      <button id="sidebar-toggle" class="sidebar-toggle">‚Üê</button>
    </aside>

    <main id="main-chat" class="main-chat">
      <header>
        <button id="mobile-sidebar-toggle" class="mobile-sidebar-toggle">‚ò∞</button>
        <div class="chat-header-title">
          <h2 id="chat-title">New Chat</h2>
          <small class="subtitle">The best Ai ‚Ä¢ ElXora</small>
        </div>
        <!-- Settings button removed -->
      </header>

      <div id="chat-messages" class="chat-messages"></div>
      <div id="typing-indicator" class="typing-indicator hidden">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <button id="attach-btn" class="attach-btn" title="Attach file">üìé</button>
          <textarea id="message-input" rows="1" placeholder="Message ElXora..." aria-label="Type your message"></textarea>
          <button id="send-btn" class="send-btn" title="Send" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>
        <input type="file" id="file-input" hidden/>
      </div>
    </main>
  </div>

  <!-- Toast (still here for messages) -->
  <div id="toast" class="toast hidden"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

  <!-- Updated script.js content with hardcoded key (paste this into your script.js file) -->
  <script>
    const GEMINI_API_BASE = "https://generativelanguage.googleapis.com/v1beta";
    const GEMINI_MODEL   = "gemini-1.5-flash";
    const API_KEY        = "AIzaSyBDnsH0DDfrulYKruh1YOkY1cy-Liogt6o";  // Hardcoded your key

    const SYSTEM_PROMPT = `You are a highly skilled, friendly senior developer who masters Luau (Roblox), Python, JavaScript/TypeScript, HTML, CSS.
You love using emojis üòÑüöÄ to make answers more engaging and fun when it feels natural.
Always write clean, modern, well-commented code.
When showing code:
- Wrap in triple backticks with correct language tag (```python, ```luau, ```js, ```html, ```css, ```ts etc.)
- Never send broken or incomplete code unless debugging
- After longer code (>10 lines) add a short explanation
- Use best practices, modern syntax, avoid deprecated features
Feel free to use emojis in your normal text responses to make them more lively and human üòäüëç`;

    const WELCOME_MESSAGE = `Hey Kevin üëã  
What can I help you with today? üöÄ`;

    // ‚îÄ‚îÄ‚îÄ DOM Elements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const 
      appContainer      = document.getElementById('app-container'),
      chatMessages      = document.getElementById('chat-messages'),
      messageInput      = document.getElementById('message-input'),
      sendBtn           = document.getElementById('send-btn'),
      attachBtn         = document.getElementById('attach-btn'),
      fileInput         = document.getElementById('file-input'),
      typingIndicator   = document.getElementById('typing-indicator'),
      chatTitle         = document.getElementById('chat-title'),
      toastEl           = document.getElementById('toast');

    // ‚îÄ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg, type = 'info') {
      toastEl.textContent = msg;
      toastEl.className = `toast ${type}`;
      toastEl.classList.remove('hidden');
      setTimeout(() => toastEl.classList.add('hidden'), 3800);
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function autoGrow(el) {
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight) + "px";
    }

    function renderMessage(sender, content) {
      const div = document.createElement('div');
      div.className = `message ${sender}-message`;
      div.innerHTML = `<div class="message-content">${marked.parse(content)}</div>`;
      chatMessages.appendChild(div);
      scrollToBottom();

      if (sender === 'ai') {
        setTimeout(() => {
          document.querySelectorAll('pre code').forEach((block) => {
            if (!block.dataset.processed) {
              Prism.highlightElement(block);
              const pre = block.parentElement;
              const copyBtn = document.createElement('button');
              copyBtn.className = 'copy-btn';
              copyBtn.textContent = 'Copy';
              copyBtn.onclick = () => {
                navigator.clipboard.writeText(block.textContent);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
              };
              pre.appendChild(copyBtn);
              block.dataset.processed = 'true';
            }
          });
        }, 100);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Gemini API Call ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function callGemini(userMessage) {
      try {
        const response = await fetch(
          `${GEMINI_API_BASE}/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ role: 'user', parts: [{ text: userMessage }] }],
              systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
              generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
            })
          }
        );

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'No response received';
      } catch (err) {
        console.error(err);
        showToast('Gemini API error: ' + err.message, 'error');
        return null;
      }
    }

    // ‚îÄ‚îÄ‚îÄ Send Message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      renderMessage('user', text);
      messageInput.value = '';
      autoGrow(messageInput);
      sendBtn.disabled = true;
      typingIndicator.classList.remove('hidden');
      scrollToBottom();

      const reply = await callGemini(text);

      typingIndicator.classList.add('hidden');
      if (reply) {
        renderMessage('ai', reply);
      } else {
        renderMessage('ai', "Sorry, something went wrong üòï");
      }
    }

    messageInput.addEventListener('input', () => {
      autoGrow(messageInput);
      sendBtn.disabled = !messageInput.value.trim();
    });

    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    // ‚îÄ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('logout-btn')?.addEventListener('click', () => {
      localStorage.removeItem('elxora_current_user');
      window.location.href = 'login.html';
    });

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener('load', () => {
      const user = JSON.parse(localStorage.getItem('elxora_current_user') || '{}');
      document.getElementById('username-display').textContent = user.username || 'User';
      document.getElementById('email-display').textContent   = user.email || '';
      document.getElementById('avatar').textContent          = (user.username || 'U').charAt(0).toUpperCase();

      chatMessages.innerHTML = '';
      renderMessage('ai', WELCOME_MESSAGE);
      messageInput.focus();
    });
  </script>
</body>
</html>
