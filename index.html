<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ElXora</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"/>
</head>
<body>

  <!-- Redirect if not logged in -->
  <script>
    if (!localStorage.getItem('elxora_current_user')) {
      window.location.replace('login.html');
    }
  </script>

  <div id="app-container" class="app-container">
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <button id="sidebar-close-btn" class="close-sidebar">Ã—</button>
      </div>
      <button id="new-chat-btn">+ New Chat</button>
      <div id="chat-list" class="chat-list"></div>
      <div id="user-info" class="user-info clickable">
        <div class="avatar" id="avatar"></div>
        <div class="user-details">
          <strong id="username-display"></strong>
          <small id="email-display"></small>
        </div>
      </div>
    </aside>

    <main id="main-chat" class="main-chat">
      <header>
        <button id="mobile-sidebar-toggle" class="mobile-sidebar-toggle">â˜°</button>
        <div class="chat-header-title">
          <h2 id="chat-title">New Chat</h2>
          <small class="subtitle">Best Ai â€¢ ElXora</small>
        </div>
      </header>

      <div id="chat-messages" class="chat-messages"></div>

      <div id="typing-indicator" class="typing-indicator hidden">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <button id="attach-btn" class="attach-btn" title="Attach file">ðŸ“Ž</button>
          <textarea id="message-input" rows="1" placeholder="Message ElXora..." aria-label="Type your message"></textarea>
          <button id="send-btn" class="send-btn" title="Send" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>
        <input type="file" id="file-input" hidden/>
      </div>
    </main>
  </div>

  <!-- Logout Modal -->
  <div id="logout-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Log Out?</h2>
      <p>Are you sure you want to log out?</p>
      <div class="modal-buttons">
        <button id="confirm-logout">Yes, Log Out</button>
        <button id="cancel-logout">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

  <script>
    const GEMINI_API_BASE = "https://generativelanguage.googleapis.com/v1beta";
    const GEMINI_MODEL = "gemini-2.0-flash"; // Updated to 2.0 Flash
    const API_KEY = "AIzaSyCc-EMppeqnyd6KajKGkY7wi4BxPZ06MXs";

    const SYSTEM_PROMPT = `You are a highly skilled, friendly senior developer who masters Luau (Roblox), Python, JavaScript/TypeScript, HTML, CSS.
You love using emojis ðŸ˜„ðŸš€ to make answers more engaging.
Always write clean, modern, well-commented code.
Wrap code in triple backticks with language tag.
Use best practices, modern syntax.`;

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('mobile-sidebar-toggle');
    const closeBtn = document.getElementById('sidebar-close-btn');
    const userInfo = document.getElementById('user-info');
    const logoutModal = document.getElementById('logout-modal');
    const confirmLogout = document.getElementById('confirm-logout');
    const cancelLogout = document.getElementById('cancel-logout');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const typingIndicator = document.getElementById('typing-indicator');
    const chatTitle = document.getElementById('chat-title');
    const toastEl = document.getElementById('toast');

    let currentChat = [];

    // Sidebar toggle
    function toggleSidebar() {
      sidebar.classList.toggle('open');
    }

    toggleBtn.addEventListener('click', toggleSidebar);
    closeBtn.addEventListener('click', toggleSidebar);

    // Click outside to close sidebar
    document.addEventListener('click', e => {
      if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });

    // Logout modal
    userInfo.addEventListener('click', () => {
      logoutModal.classList.remove('hidden');
    });

    cancelLogout.addEventListener('click', () => {
      logoutModal.classList.add('hidden');
    });

    confirmLogout.addEventListener('click', () => {
      localStorage.removeItem('elxora_current_user');
      window.location.href = 'login.html';
    });

    // â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type = 'info') {
      toastEl.textContent = msg;
      toastEl.className = `toast ${type}`;
      toastEl.classList.remove('hidden');
      setTimeout(() => toastEl.classList.add('hidden'), 4000);
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function autoGrow(el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + "px";
    }

    function renderMessage(sender, content) {
      const div = document.createElement('div');
      div.className = `message ${sender}-message`;
      div.innerHTML = `<div class="message-content">${marked.parse(content)}</div>`;
      chatMessages.appendChild(div);
      scrollToBottom();

      if (sender === 'ai') {
        setTimeout(() => {
          document.querySelectorAll('pre code').forEach(block => {
            if (!block.dataset.processed) {
              Prism.highlightElement(block);
              block.dataset.processed = 'true';
            }
          });
        }, 100);
      }
    }

    // â”€â”€â”€ Gemini API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function callGemini(userMessage) {
      try {
        const response = await fetch(
          `${GEMINI_API_BASE}/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ role: 'user', parts: [{ text: userMessage }] }],
              systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
              generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
            })
          }
        );

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(errData.error?.message || `HTTP ${response.status}`);
        }

        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'No response';
      } catch (err) {
        console.error("Gemini error:", err);
        showToast('Chat failed: ' + err.message, 'error');
        return null;
      }
    }

    // â”€â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      renderMessage('user', text);
      currentChat.push({ role: 'user', content: text });

      messageInput.value = '';
      autoGrow(messageInput);
      sendBtn.disabled = true;
      typingIndicator.classList.remove('hidden');
      scrollToBottom();

      const reply = await callGemini(text);

      typingIndicator.classList.add('hidden');
      if (reply) {
        renderMessage('ai', reply);
        currentChat.push({ role: 'ai', content: reply });
      } else {
        renderMessage('ai', "Sorry, something went wrong ðŸ˜•");
      }

      sendBtn.disabled = false;
    }

    messageInput.addEventListener('input', () => {
      autoGrow(messageInput);
      sendBtn.disabled = !messageInput.value.trim();
    });

    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    // â”€â”€â”€ New Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('new-chat-btn')?.addEventListener('click', () => {
      currentChat = [];
      chatMessages.innerHTML = '';
      chatTitle.textContent = 'New Chat';
      renderMessage('ai', "New chat started. Ask me anything ðŸš€");
    });

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('load', () => {
      const user = JSON.parse(localStorage.getItem('elxora_current_user') || '{}');
      document.getElementById('username-display').textContent = user.username || 'User';
      document.getElementById('email-display').textContent   = user.email || '';
      document.getElementById('avatar').textContent          = (user.username || 'U').charAt(0).toUpperCase();

      chatMessages.innerHTML = '';
      renderMessage('ai', "Welcome to ElXora! Ask me anything ðŸ˜„");
      messageInput.focus();
    });
  </script>
</body>
                                                                                                                 </html>
